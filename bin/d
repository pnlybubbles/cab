#!/bin/sh

start () {
  echo 'starting container: '$1
  local opt=$2
  if [ ! -z $port ]; then
    if [ -z `echo $port | grep ':'` ]; then
      local used_ports=`docker inspect \
        --format '{{range .NetworkSettings.Ports}}{{index (index . 0) "HostPort"}}{{end}}' \
        $replica_ids`
      local host_port='4000'
      while [ ! -z `echo $used_ports | grep $host_port` ]
      do
        host_port=`expr $host_port + 1`
      done
      port=$host_port':'$port
    fi
    opt=$opt' -p '$port
  fi
  local name=`echo $PWD | sed -e s#/#-#g | sed -e s/^-//`
  docker run \
    -v $host_pwd:/main \
    $opt \
    --name $name \
    --label cab.replica \
    --label cab.path="$PWD" \
    --rm \
    -itd \
    $1 \
    sh
  update_current
}

execute () {
  docker exec \
    -it \
    $current_id \
    sh -c "cd /main && $*"
}

status() {
  if [ ! -z "$replica_ids" ]; then
    docker inspect \
      --format '{{.Config.Hostname}} {{.State.Status}} {{.Config.Image}} {{range $i, $_ := .NetworkSettings.Ports}}{{index (index . 0) "HostPort"}}:{{$i}} {{end}} {{index .Config.Labels "cab.path"}}' \
      $replica_ids
  fi
}

stop () {
  docker stop $current_id
}

update_current () {
  current_id=`docker ps -q -f "label=cab.path=$PWD"`
}

host_home='/Users/pnlybubbles'
host_pwd=$host_home$PWD
current_id=''
replica_ids=`docker ps -q -f 'label=cab.replica' | tr '\n' ' '`
update_current

if [ -z $1 ]; then
  echo -e 'Usage: d [OPTIONS] [COMMAND]'
  echo -e
  echo -e 'Options:'
  echo -e '\t-i, --image [IMAGE]'
  echo -e '\t-p, --port [GUEST]'
  echo -e '\t-s, --status'
  echo -e '\t    --stop'
  return 0
fi

image=''
port=''
while :
do
  case $1 in
    '-i' | '--image' )
      shift; image=$1; shift
      ;;
    '-p' | '--port' )
      shift; port=$1; shift
      ;;
    '--stop')
      stop
      return 0
      ;;
    '-s' | '--status' )
      status
      return 0
      ;;
    * )
      break
      ;;
  esac
done

if [ ! -z $current_id ]; then
  execute $*
else
  if [ ! -z $image ]; then
    start $image
  else
    case $1 in
      'node' | 'npm' | 'yarn' )
        start 'node:alpine' '-v /main/node_modules'
        ;;
      * )
        echo 'ERROR: Container is not running'
        return 1
        ;;
    esac
  fi
  execute $*
fi

return 0
